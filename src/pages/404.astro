---
import Layout from '../layout/Layout.astro';
---

<Layout title="Resolving...">
  <div id="loading-state" class="flex-1 flex flex-col items-center justify-center p-4 space-y-6">
    <div class="animate-spin text-white">
        <i class="iconoir-system-restart text-5xl"></i>
    </div>
    <p class="text-neutral-400 font-mono italic">Locating link...</p>
  </div>

  <div id="error-state" class="hidden mt-[calc(50vh-112px)] flex-1 flex-col items-center justify-center text-center space-y-6 p-4">
    <h1 class="text-6xl font-bold text-white">404</h1>
    <p class="text-xl text-neutral-400 font-mono">Page not found.</p>
    <a href="/" class="text-white underline decoration-2 underline-offset-8 hover:opacity-80 transition-opacity">
      Go back home
    </a>
  </div>

  <div id="redirect-state" class="hidden flex-1 flex-col items-center justify-center text-center space-y-8 p-4 max-w-lg mx-auto">
    <div class="space-y-2 w-full">
        <p id="preview-label" class="text-neutral-500 text-xs uppercase tracking-widest font-bold">Preview Target</p>
        <div class="p-4 bg-surface border border-border rounded-lg break-all">
            <h2 id="target-preview" class="text-sm text-neutral-300 font-mono line-clamp-2">...</h2>
        </div>
    </div>
    
    <div class="flex flex-col items-center space-y-4" id="countdown-container">
        <div class="w-20 h-20 rounded-full border-2 border-white/20 flex items-center justify-center relative">
            <span id="countdown" class="text-3xl font-bold">5</span>
            <svg class="absolute inset-0 w-full h-full -rotate-90 translate-x-[1.5px] translate-y-0.5">
                <circle cx="40" cy="40" r="36" fill="none" stroke="white" stroke-width="2" stroke-dasharray="226" id="progress-ring" />
            </svg>
        </div>
        <p id="redirect-subtext" class="text-neutral-400 text-sm">Redirecting automatically...</p>
    </div>

    <button id="manual-btn" class="px-8 py-3 bg-white text-black font-bold rounded-full hover:bg-neutral-200 transition-all active:scale-95 flex items-center gap-2">
        <span id="btn-text">Proceed Now</span>
        <i class="iconoir-nav-arrow-right"></i>
    </button>
  </div>
</Layout>

<script>
    interface Config {
        prefix: string;
        user: string;
        repo: string;
        default?: boolean;
    }

    const B32_CHARS = "0123456789ABCDEFGHJKMNPQRSTVWXYZ";
    
    const ui = {
        loading: document.getElementById('loading-state') as HTMLDivElement,
        error: document.getElementById('error-state') as HTMLDivElement,
        redirect: document.getElementById('redirect-state') as HTMLDivElement,
        preview: document.getElementById('target-preview') as HTMLElement,
        label: document.getElementById('preview-label') as HTMLElement,
        subtext: document.getElementById('redirect-subtext') as HTMLElement,
        count: document.getElementById('countdown') as HTMLElement,
        btn: document.getElementById('manual-btn') as HTMLButtonElement,
        btnText: document.getElementById('btn-text') as HTMLElement,
        ring: document.getElementById('progress-ring') as unknown as SVGCircleElement
    };

    function getUlidAndPrefix() {
        const path = window.location.pathname.replace(/\/$/, '');
        const segs = path.split('/').filter(Boolean);
        if (segs.length === 0) return { id: null, prefix: null };
        if (segs.length >= 2 && segs[segs.length - 1].length === 10) {
            return { id: segs[segs.length - 1], prefix: segs[segs.length - 2] };
        }
        const last = segs[segs.length - 1];
        if (last.length === 10) return { id: last, prefix: null };
        return { id: null, prefix: null };
    }

    function getParamsFromHash() {
        const hash = window.location.hash.substring(1);
        const params = new URLSearchParams(hash);
        const u = params.get('u');
        const r = params.get('r');
        return (u && r) ? { user: u, repo: r } : null;
    }

    function getPath(id: string, user: string, repo: string) {
        let time = 0;
        for (let i = 0; i < 10; i++) {
            const val = B32_CHARS.indexOf(id[i].toUpperCase());
            if (val === -1) return null;
            time = time * 32 + val;
        }
        const d = new Date(time);
        return `https://raw.githubusercontent.com/${user}/${repo}/main/data/${d.getUTCFullYear()}/${String(d.getUTCMonth() + 1).padStart(2, '0')}/${id}.json`;
    }

    function showState(state: 'loading' | 'error' | 'redirect') {
        ui.loading.classList.toggle('hidden', state !== 'loading');
        ui.error.classList.toggle('hidden', state !== 'error');
        ui.redirect.classList.toggle('hidden', state !== 'redirect');
        if (state === 'redirect') {
            ui.redirect.classList.add('flex');
            ui.redirect.classList.remove('hidden');
        }
    }

    function startCounter(targetUrl: string, seconds: number) {
        let count = seconds;
        ui.count.textContent = count.toString();
        ui.btn.onclick = () => window.location.replace(targetUrl);
        if (ui.ring) ui.ring.style.strokeDashoffset = "0";
        const interval = setInterval(() => {
            count--;
            if (ui.count) ui.count.textContent = count.toString();
            const progress = (seconds - count) / seconds;
            if (ui.ring) ui.ring.style.strokeDashoffset = String(226 * (1 - progress));
            if (count <= 0) { clearInterval(interval); window.location.replace(targetUrl); }
        }, 1000);
    }

    function fallbackToHome(msg: string) {
        showState('redirect');
        ui.label.textContent = msg;
        ui.preview.textContent = window.location.origin;
        ui.subtext.textContent = "Redirecting you to home page...";
        ui.btnText.textContent = "Go Home Now";
        startCounter(window.location.origin, 5); // Corrected from 500 to 5
    }

    async function fetchTarget(id: string, user: string, repo: string) {
        try {
            const jsonPath = getPath(id, user, repo);
            if (!jsonPath) throw new Error();
            const resPath = await fetch(jsonPath + `?t=${Date.now()}`);
            if (!resPath.ok) throw new Error();
            const pathData = await resPath.json();
            showState('redirect');
            ui.preview.textContent = pathData.target;
            startCounter(pathData.target, 3);
        } catch {
            fallbackToHome("Link Not Found on GitHub");
        }
    }

    /**
     * ORCHESTRATOR - Corrected Priority Logic
     */
    async function init() {
        const { id, prefix } = getUlidAndPrefix();
        if (!id) return fallbackToHome("Invalid Link Format");

        // PRIORITY 1: HASH PARAMS (Must come first to support Custom unregistered repos)
        const hashParams = getParamsFromHash();
        if (hashParams) {
            console.log("Using Hash Params:", id, hashParams.user, hashParams.repo);
            return fetchTarget(id, hashParams.user, hashParams.repo);
        }

        // PRIORITY 2: DOMAINS.JSON (Prefix or Default)
        try {
            const resDomain = await fetch('/domains.json');
            const configs: Config[] = await resDomain.json();
            
            const config = prefix 
                ? configs.find(c => c.prefix === prefix) 
                : configs.find(c => c.prefix === "" || c.default);

            if (!config) return fallbackToHome("Slug/Prefix Not Found");

            console.log("Using Registered Config:", id, config.user, config.repo);
            return fetchTarget(id, config.user, config.repo);

        } catch (e) {
            fallbackToHome("System Resolution Error");
        }
    }

    init();
</script>